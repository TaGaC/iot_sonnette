{% extends "base.html" %}
{% block content %}
<div class="card">
    <div class="card-body">
        <h3 class="card-title">Tableau de bord</h3>
        <div class="etat-live" id="etat-live">
            <b>Quelqu'un a appuyé sur la sonnette ?</b>
            <span id="bell-badge" class="badge bg-secondary">Non</span>
            &nbsp;|&nbsp;
            <b>ALERTE INTRUS ?</b>
            <span id="intrus-badge" class="badge bg-secondary">Non</span>
        </div>
        <hr>
        <h5>Historique des sonneries :</h5>
        <ul class="list-group mb-3" id="bell-list"></ul>
        <h5>Alertes INTRUS :</h5>
        <ul class="list-group" id="intrus-list"></ul>
    </div>
</div>
<script>
function updatePanel() {
    fetch("/api/state")
    .then(r => r.json())
    .then(data => {
        document.getElementById("bell-badge").textContent = data.bell ? "En cours" : "Non";
        document.getElementById("bell-badge").className = "badge " + (data.bell ? "bg-warning text-dark" : "bg-secondary");
        document.getElementById("intrus-badge").textContent = data.intrus ? "?? OUI" : "Non";
        document.getElementById("intrus-badge").className = "badge " + (data.intrus ? "bg-danger" : "bg-secondary");
    });
    fetch("/api/events")
    .then(r => r.json())
    .then(data => {
        let bellList = document.getElementById("bell-list");
        bellList.innerHTML = "";
        if (data.bell_events.length === 0) {
            bellList.innerHTML = '<li class="list-group-item text-muted">Aucune sonnerie détectée.</li>';
        } else {
            data.bell_events.forEach(e => {
                let li = document.createElement("li");
                li.className = "list-group-item";
                li.textContent = "Sonnette à " + e.timestamp;
                bellList.appendChild(li);
            });
        }
        let intrusList = document.getElementById("intrus-list");
        intrusList.innerHTML = "";
        if (data.intrus_events.length === 0) {
            intrusList.innerHTML = '<li class="list-group-item text-muted">Aucune alerte intrus.</li>';
        } else {
            data.intrus_events.forEach(e => {
                let li = document.createElement("li");
                li.className = "list-group-item list-group-item-danger";
                li.textContent = "ALERTE INTRUS à " + e.timestamp;
                intrusList.appendChild(li);
            });
        }
    });
}
setInterval(updatePanel, 2000);
window.onload = updatePanel;
</script>
{% endblock %}
