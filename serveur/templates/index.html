{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-3">
  <div class="row g-3">
    <!-- COLONNE GAUCHE -->
    <div class="col-md-6">
      <!-- Haut gauche : Fonctions de contrôle -->
      <div class="card mb-3">
        <div class="card-body">
          <h4 class="card-title mb-3">Contrôle</h4>
          <button class="btn btn-primary mb-2" disabled>Ouvrir la porte</button>
          <button class="btn btn-secondary mb-2" disabled>Enregistrer audio</button>
          <!-- Ajoute ici d'autres boutons/fonctionnalités... -->
        </div>
      </div>
      <!-- Bas gauche : Flux vidéo (factice) -->
      <div class="card">
        <div class="card-body text-center">
          <h4 class="card-title mb-3">Vidéo Porte</h4>
          <div class="border rounded" style="background:#333; height:200px; color:#fff; display:flex; align-items:center; justify-content:center;">
            [Flux vidéo indisponible]
          </div>
        </div>
      </div>
    </div>
    <!-- COLONNE DROITE -->
    <div class="col-md-6">
      <!-- Haut droite : Historique Sonneries -->
      <div class="card mb-3">
        <div class="card-body">
          <h4 class="card-title">Historique des sonneries</h4>
          <div id="bell-history"></div>
        </div>
      </div>
      <!-- Bas droite : Historique Intrusions -->
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Alertes INTRUS</h4>
          <div id="intrus-history"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const VAPID_PUBLIC_KEY = "MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE7EGr3lk9ueDO4yiCadqtIl_BYrrCrMjkzd5RoRlAPZy4O8nPxEbRipzdXZJfHVbh1aYfZOpEm4dok8HOVROBfA";  // Clé publique en base64url (sans les = à la fin)

async function initPush() {
  if (!("serviceWorker" in navigator)) {
    console.warn("Service worker non supporté.");
    return;
  }

  const reg = await navigator.serviceWorker.register("/static/sw.js");
  console.log("Service worker enregistré", reg);

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    console.warn("Permission de notification refusée.");
    return;
  }

  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
  });

  await fetch("/subscribe", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub)
  });

  console.log("Abonnement envoyé au serveur.");
}

// Conversion de base64url → Uint8Array (nécessaire pour Chrome/Firefox)
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, '+')
    .replace(/_/g, '/');
  const raw = atob(base64);
  return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}

initPush();

function groupByDay(events) {
  // events: array of "YYYY-MM-DD HH:MM:SS" (déjà à l'heure locale !)
  const grouped = {};
  events.forEach(ev => {
    const [date, time] = ev.split(' ');
    const [year, month, day] = date.split('-');
    const eventDate = new Date(`${date}T${time}`);
    // Utilise Intl.DateTimeFormat pour localiser le nom du jour/mois en français
    const dayLabel = eventDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    if (!grouped[dayLabel]) grouped[dayLabel] = [];
    // Extrait juste l'heure sans les secondes
    const hourMin = time.slice(0, 5);
    grouped[dayLabel].push(hourMin);
  });
  return grouped;
}

// Connecte au flux serveur
const evtSource = new EventSource("/stream");

evtSource.onmessage = e => {
  const data = JSON.parse(e.data);

  // Historique sonneries (groupé par jour puis heure)
  const bellGrouped = groupByDay(data.bell_events || []);
  const bellDiv = document.getElementById("bell-history");
  bellDiv.innerHTML = "";
  if (Object.keys(bellGrouped).length === 0) {
    bellDiv.innerHTML = '<div class="text-muted">Aucune sonnerie détectée.</div>';
  } else {
    for (const [day, hours] of Object.entries(bellGrouped)) {
      let html = `<div class="fw-bold mb-1">${day.charAt(0).toUpperCase() + day.slice(1)} :</div><ul class="list-group mb-2">`;
      hours.forEach(hhmm => {
        html += `<li class="list-group-item py-1">Sonnette à ${hhmm}</li>`;
      });
      html += '</ul>';
      bellDiv.innerHTML += html;
    }
  }

  // Historique intrus (groupé par jour puis heure)
  const intrusGrouped = groupByDay(data.intrus_events || []);
  const intrusDiv = document.getElementById("intrus-history");
  intrusDiv.innerHTML = "";
  if (Object.keys(intrusGrouped).length === 0) {
    intrusDiv.innerHTML = '<div class="text-muted">Aucune alerte intrus.</div>';
  } else {
    for (const [day, hours] of Object.entries(intrusGrouped)) {
      let html = `<div class="fw-bold mb-1">${day.charAt(0).toUpperCase() + day.slice(1)} :</div><ul class="list-group mb-2">`;
      hours.forEach(hhmm => {
        html += `<li class="list-group-item list-group-item-danger py-1">ALERTE INTRUS à ${hhmm}</li>`;
      });
      html += '</ul>';
      intrusDiv.innerHTML += html;
    }
  }
};

evtSource.onerror = err => {
  console.error("SSE error:", err);
};
</script>
{% endblock %}
