{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-3">
  <div class="row g-3">
    <!-- COLONNE GAUCHE -->
    <div class="col-md-6">
      <!-- Haut gauche : Fonctions de contr√¥le -->
      <div class="card mb-3">
        <div class="card-body">
          <h4 class="card-title mb-3">Contr√¥le</h4>
          <button class="btn btn-primary mb-2" disabled>Ouvrir la porte</button>
          <button class="btn btn-secondary mb-2" disabled>Enregistrer audio</button>
          <!-- Ajoute ici d'autres boutons/fonctionnalit√©s... -->
        </div>
      </div>
      <!-- Bas gauche : Flux vid√©o (factice) -->
      <div class="card">
        <div class="card-body text-center">
          <h4 class="card-title mb-3">Vid√©o Porte</h4>
          <div class="border rounded" style="background:#333; height:200px; color:#fff; display:flex; align-items:center; justify-content:center;">
            [Flux vid√©o indisponible]
          </div>
        </div>
      </div>
    </div>
    <!-- COLONNE DROITE -->
    <div class="col-md-6">
      <!-- Haut droite : Historique Sonneries -->
      <div class="card mb-3">
        <div class="card-body">
          <h4 class="card-title">Historique des sonneries</h4>
          <div id="bell-history"></div>
        </div>
      </div>
      <!-- Bas droite : Historique Intrusions -->
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Alertes INTRUS</h4>
          <div id="intrus-history"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

navigator.serviceWorker.register('/static/sw.js').then(reg => {
  return reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: "MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE7EGr3lk9ueDO4yiCadqtIl_BYrrCrMjkzd5RoRlAPZy4O8nPxEbRipzdXZJfHVbh1aYfZOpEm4dok8HOVROBfA"
  });
}).then(subscription => {
  return fetch('/subscribe', {
    method: 'POST',
    body: JSON.stringify(subscription),
    headers: { 'Content-Type': 'application/json' }
  });
}).then(() => {
  console.log("üì¨ Abonnement push enregistr√©.");
}).catch(console.error);


function groupByDay(events) {
  // events: array of "YYYY-MM-DD HH:MM:SS" (d√©j√† √† l'heure locale !)
  const grouped = {};
  events.forEach(ev => {
    const [date, time] = ev.split(' ');
    const [year, month, day] = date.split('-');
    const eventDate = new Date(`${date}T${time}`);
    // Utilise Intl.DateTimeFormat pour localiser le nom du jour/mois en fran√ßais
    const dayLabel = eventDate.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    if (!grouped[dayLabel]) grouped[dayLabel] = [];
    // Extrait juste l'heure sans les secondes
    const hourMin = time.slice(0, 5);
    grouped[dayLabel].push(hourMin);
  });
  return grouped;
}

// Connecte au flux serveur
const evtSource = new EventSource("/stream");

evtSource.onmessage = e => {
  const data = JSON.parse(e.data);

  // Historique sonneries (group√© par jour puis heure)
  const bellGrouped = groupByDay(data.bell_events || []);
  const bellDiv = document.getElementById("bell-history");
  bellDiv.innerHTML = "";
  if (Object.keys(bellGrouped).length === 0) {
    bellDiv.innerHTML = '<div class="text-muted">Aucune sonnerie d√©tect√©e.</div>';
  } else {
    for (const [day, hours] of Object.entries(bellGrouped)) {
      let html = `<div class="fw-bold mb-1">${day.charAt(0).toUpperCase() + day.slice(1)} :</div><ul class="list-group mb-2">`;
      hours.forEach(hhmm => {
        html += `<li class="list-group-item py-1">Sonnette √† ${hhmm}</li>`;
      });
      html += '</ul>';
      bellDiv.innerHTML += html;
    }
  }

  // Historique intrus (group√© par jour puis heure)
  const intrusGrouped = groupByDay(data.intrus_events || []);
  const intrusDiv = document.getElementById("intrus-history");
  intrusDiv.innerHTML = "";
  if (Object.keys(intrusGrouped).length === 0) {
    intrusDiv.innerHTML = '<div class="text-muted">Aucune alerte intrus.</div>';
  } else {
    for (const [day, hours] of Object.entries(intrusGrouped)) {
      let html = `<div class="fw-bold mb-1">${day.charAt(0).toUpperCase() + day.slice(1)} :</div><ul class="list-group mb-2">`;
      hours.forEach(hhmm => {
        html += `<li class="list-group-item list-group-item-danger py-1">ALERTE INTRUS √† ${hhmm}</li>`;
      });
      html += '</ul>';
      intrusDiv.innerHTML += html;
    }
  }
};

evtSource.onerror = err => {
  console.error("SSE error:", err);
};
</script>
{% endblock %}
